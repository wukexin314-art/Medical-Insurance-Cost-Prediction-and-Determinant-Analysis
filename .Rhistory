read.csv(""D:/R/6414/project/insurance.csv"")
read.csv("D:/R/6414/project/insurance.csv")
data <- read.csv("D:/R/6414/project/insurance.csv")
View(data)
library(tidyverse)
library(rlang)
detach("package:rlang", unload = TRUE)
library(tidyverse)
library(rlang)
library(tidyverse)
library(tidyverse)
install.packages("tidyverse")
library(tidyverse)
library(car)
install.packages("car")
library(car)
delete.response(data)
rm(data)
# 2. Read data
insurance <- read.csv("insurance.csv")
# 2. Read data
insurance <- read.csv("insurance.csv")
# 3. Data overview
str(insurance)
View(insurance)
summary(insurance)
# 4. Encode categorical variables
insurance$sex <- factor(insurance$sex, levels = c("female", "male"))
insurance$smoker <- factor(insurance$smoker, levels = c("no", "yes"))
insurance$region <- factor(insurance$region)
# 5. Multiple Linear Regression
fit_full <- lm(charges ~ age + sex + bmi + children + smoker + region, data = insurance)
summary(fit_full)
# 6. Diagnostic checks
par(mfrow = c(2, 2))
plot(fit_full)
vif(fit_full)  # multicollinearity check
insurance <- read.csv("insurance.csv")
str(insurance)
summary(insurance)
insurance$sex <- factor(insurance$sex, levels = c("female", "male"))
insurance$smoker <- factor(insurance$smoker, levels = c("no", "yes"))
insurance$region <- factor(insurance$region)
summary(insurance)
summary(select(insurance, age, bmi, children, charges))
# 4-1. EDA
summary(insurance[, c("age", "bmi", "children", "charges")])
ggplot(insurance, aes(age, charges)) +
geom_point(alpha=0.4) + geom_smooth(method="lm") +
labs(title="Charges vs Age")
library(tidyverse)
ggplot(insurance, aes(age, charges)) +
geom_point(alpha=0.4) + geom_smooth(method="lm") +
labs(title="Charges vs Age")
ggplot(insurance, aes(bmi, charges)) +
geom_point(alpha=0.4) + geom_smooth(method="lm") +
labs(title="Charges vs BMI")
ggplot(insurance, aes(smoker, charges, fill=smoker)) +
geom_boxplot() + theme_minimal()
fit_full <- lm(charges ~ age + sex + bmi + children + smoker + region, data = insurance)
summary(fit_full)
par(mfrow = c(2, 2))
plot(fit_full)
par(mfrow = c(1, 1))
vif(fit_full)  # multicollinearity check
library(broom)
par(mfrow = c(2, 2))
plot(fit_full)
par(mfrow = c(1, 1))
vif(fit_full)
par(mfrow = c(4, 4))
plot(fit_full)
par(mfrow = c(1, 1))
vif(fit_full)
par(mfrow = c(1, 1))
plot(fit_full)
insurance_clean <- insurance[-c(1301, 578, 544), ]
fit_clean <- lm(charges ~ age + sex + bmi + children + smoker + region, data = insurance_clean)
summary(fit_clean)
summary(fit_full)$coefficients
summary(fit_clean)$coefficients
plot(fit_clean)
fit_interact <- lm(charges ~ age + sex + bmi * smoker + children + region, data = insurance)
summary(fit_interact)
# 7.2 Add interation term bmi*smoker
fit_interact <- lm(charges ~ age + sex + bmi * smoker + children + region, data = insurance_clean)
summary(fit_interact)
anova(fit_full, fit_interact)
AIC(fit_full, fit_interact)
fit_interact <- lm(charges ~ age + sex + bmi * smoker + children + region, data = insurance)
summary(fit_interact)
anova(fit_full, fit_interact)
AIC(fit_full, fit_interact)
ggplot(insurance, aes(x = bmi, y = charges, color = smoker)) +
geom_point(alpha = 0.4) +
geom_smooth(method = "lm", se = FALSE) +
labs(title = "Interaction: BMI × Smoker",
x = "BMI", y = "Insurance Charges (USD)")
library(ggplot2)
ggplot(insurance, aes(x = bmi, y = charges, color = smoker)) +
geom_point(alpha = 0.4) +
geom_smooth(method = "lm", se = FALSE) +
labs(title = "Interaction: BMI × Smoker",
x = "BMI", y = "Insurance Charges (USD)")
plot(fit_interact)
par(mfrow = c(2, 2))
plot(fit_interact)
bc<-boxcox(fit_interact, lambda = seq(-2, 2, 0.1))
library(MASS)
bc<-boxcox(fit_interact, lambda = seq(-2, 2, 0.1))
par(mfrow = c(1, 1))
bc<-boxcox(fit_interact, lambda = seq(-2, 2, 0.1))
fit_log <- lm(log(charges) ~ age + sex + bmi * smoker + children + region, data = insurance)
summary(fit_log)
AIC(fit_full, fit_log)
par(mfrow=c(2,2))
plot(fit_log)
fit_null  <- lm(log(charges) ~ 1, data = insurance)
fit_full  <- lm(log(charges) ~ age + sex + bmi * smoker + children + region, data = insurance)
fit_forward <- step(fit_null,
scope = list(lower = formula(fit_null),
upper  = formula(fit_full)),
direction = "forward",
trace = TRUE)
summary(fit_forward)
# 8. Forward selection based on AIC
vars <- c("age", "sex", "bmi", "children", "smoker", "region", "bmi:smoker")
current_model <- lm(log(charges) ~ 1, data = insurance)   # null model
remaining <- vars
while (length(remaining) > 0) {
pvals <- c()
# Try adding each remaining predictor and extract its p-value
for (v in remaining){
f <- as.formula(paste("log(charges) ~", paste(c(attr(terms(current_model), "term.labels"), v), collapse="+")))
m <- lm(f, data = insurance)
pvals[v] <- anova(current_model, m)$`Pr(>F)`[2]
}
# Choose smallest p-value
best <- names(which.min(pvals))
best_p <- min(pvals)
# Entry criterion: p-value < 0.05
if(best_p < 0.05){
message(paste("Adding:", best, "| p-value =", round(best_p, 6)))
current_model <- update(current_model, paste(". ~ . +", best))
remaining <- setdiff(remaining, best)
} else {
message("No predictors meet the entry criterion; stopping.")
break
}
}
while (length(remaining) > 0) {
pvals <- c()
# Try adding each remaining predictor and extract its p-value
for (v in remaining){
f <- as.formula(paste("log(charges) ~", paste(c(attr(terms(current_model), "term.labels"), v), collapse="+")))
m <- lm(f, data = insurance)
pvals[v] <- anova(current_model, m)$`Pr(>F)`[2]
}
# Choose smallest p-value
best <- names(which.min(pvals))
best_p <- min(pvals)
# Entry criterion: p-value < 0.05
if(best_p < 0.05){
message(paste("Adding:", best, "| p-value =", round(best_p, 6)))
current_model <- update(current_model, paste(". ~ . +", best))
remaining <- setdiff(remaining, best)
} else {
message("No predictors meet the entry criterion; stopping.")
break
}
}
while (length(remaining) > 0) {
pvals <- c()
for (v in remaining) {
f <- as.formula(
paste("log(charges) ~",
paste(c(attr(terms(current_model), "term.labels"), v), collapse = " + "))
)
m <- lm(f, data = insurance)
# 提取 p-value（第二行 ANOVA 的 p-value）
p <- anova(current_model, m)$`Pr(>F)`[2]
# 避免 NA：只添加非 NA 的 p-value
if (!is.na(p)) {
pvals[v] <- p
}
}
# 如果所有候选都 NA → 停止
if (length(pvals) == 0) {
message("No valid p-values — stopping.")
break
}
best <- names(which.min(pvals))
best_p <- min(pvals)
cat("Candidate:", best, "p =", best_p, "\n")
if (!is.na(best_p) && best_p < 0.05) {
message(paste("Adding:", best))
current_model <- update(current_model, paste(". ~ . +", best))
remaining <- setdiff(remaining, best)
} else {
message("No predictors meet the entry criterion; stopping.")
break
}
}
summary(current_model)
while (length(remaining) > 0) {
pvals <- c()
for (v in remaining) {
f <- as.formula(
paste("log(charges) ~",
paste(c(attr(terms(current_model), "term.labels"), v), collapse = " + "))
)
m <- lm(f, data = insurance)
p <- anova(current_model, m)$`Pr(>F)`[2]
if (!is.na(p)) {
pvals[v] <- p
}
}
if (length(pvals) == 0) {
message("No valid p-values — stopping.")
break
}
best <- names(which.min(pvals))
best_p <- min(pvals)
cat("Candidate:", best, "p =", best_p, "\n")
if (!is.na(best_p) && best_p < 0.05) {
message(paste("Adding:", best))
current_model <- update(current_model, paste(". ~ . +", best))
remaining <- setdiff(remaining, best)
} else {
message("No predictors meet the entry criterion; stopping.")
break
}
}
vars <- c("age", "sex", "bmi", "children", "smoker", "region", "bmi:smoker")
current_model <- lm(log(charges) ~ 1, data = insurance)
remaining <- vars
while (length(remaining) > 0) {
pvals <- c()
for (v in remaining) {
f <- as.formula(
paste("log(charges) ~",
paste(c(attr(terms(current_model), "term.labels"), v), collapse = " + "))
)
m <- lm(f, data = insurance)
p <- anova(current_model, m)$`Pr(>F)`[2]
if (!is.na(p)) {
pvals[v] <- p
}
}
if (length(pvals) == 0) {
message("No valid p-values — stopping.")
break
}
best <- names(which.min(pvals))
best_p <- min(pvals)
cat("Candidate:", best, "p =", best_p, "\n")
if (!is.na(best_p) && best_p < 0.05) {
message(paste("Adding:", best))
current_model <- update(current_model, paste(". ~ . +", best))
remaining <- setdiff(remaining, best)
} else {
message("No predictors meet the entry criterion; stopping.")
break
}
}
summary(current_model)
View(current_model)
summary(current_model)
# 10. k-Fold cross-validation (optional)
fit_final <- lm(log(charges) ~ age + sex + bmi*smoker + children + region,
data = insurance)
library(boot)
set.seed(6414)
cv_result <- cv.glm(insurance, fit_final, K = 10)
cv_result$delta
set.seed(6414)
cv_result <- cv.glm(insurance, fit_final, K = 10)
cv_result$delta
set.seed(123)
cv_result <- cv.glm(insurance, fit_final, K = 10)
cv_result$delta
fit_final <- lm(log(charges) ~ age + sex + bmi*smoker + children + region,
data = insurance)
set.seed(123)
cv_result <- cv.glm(insurance, fit_final, K = 10)
cv_result$delta
par(mfrow = c(2, 2))
plot(fit_full)
# 8. Forward selection based on AIC
vars <- c("age", "sex", "bmi", "children", "smoker", "region", "bmi:smoker")
current_model <- lm(log(charges) ~ 1, data = insurance)
remaining <- vars
while (length(remaining) > 0) {
pvals <- c()
for (v in remaining) {
f <- as.formula(
paste("log(charges) ~",
paste(c(attr(terms(current_model), "term.labels"), v), collapse = " + "))
)
m <- lm(f, data = insurance)
p <- anova(current_model, m)$`Pr(>F)`[2]
if (!is.na(p)) {
pvals[v] <- p
}
}
if (length(pvals) == 0) {
message("No valid p-values — stopping.")
break
}
best <- names(which.min(pvals))
best_p <- min(pvals)
cat("Candidate:", best, "p =", best_p, "\n")
if (!is.na(best_p) && best_p < 0.05) {
message(paste("Adding:", best))
current_model <- update(current_model, paste(". ~ . +", best))
remaining <- setdiff(remaining, best)
} else {
message("No predictors meet the entry criterion; stopping.")
break
}
}
summary(current_model)
